name: Test Coverage

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: ""
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    
    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install --yes --no-install-recommends postgresql-client

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.24

      - name: Initialize test database
        run: |
          psql -h localhost -U postgres -f .github/workflows/data/init.sql

      - name: Download dependencies
        run: go mod download

      - name: Generate coverage profile
        run: |
          go test ./... -coverprofile=./cover.out -covermode=atomic -coverpkg=./...
        continue-on-error: true  # Don't fail if some tests fail, still show coverage

      - name: Download base coverage (for comparison on PRs)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-coverage-breakdown
          path: .
        continue-on-error: true  # Don't fail if base coverage doesn't exist yet

      - name: Check if base coverage exists
        id: check_base_coverage
        if: github.event_name == 'pull_request'
        run: |
          if [ -f "coverage-breakdown.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check test coverage (with base comparison)
        if: github.event_name == 'pull_request' && steps.check_base_coverage.outputs.exists == 'true'
        uses: vladopajic/go-test-coverage@v2
        with:
          config: ./.testcoverage.yml
          profile: cover.out
          local-prefix: github.com/roneli/fastgql
          git-token: ''
          git-branch: ${{ github.head_ref }}

      - name: Check test coverage (without base comparison)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && steps.check_base_coverage.outputs.exists == 'false')
        uses: vladopajic/go-test-coverage@v2
        with:
          config: ./.testcoverage.yml
          profile: cover.out
          local-prefix: github.com/roneli/fastgql
          git-token: ${{ github.ref_name == 'master' && secrets.GITHUB_TOKEN || '' }}
          git-branch: ${{ github.head_ref }}

      - name: Upload coverage breakdown for base branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: base-coverage-breakdown
          path: coverage-breakdown.json
          retention-days: 30

